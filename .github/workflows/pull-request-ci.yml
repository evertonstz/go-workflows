name: Pull Request CI

on:
  pull_request:
    branches: ["main"]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"

      - name: Check formatting with goimports
        run: |
          if [ "$(go tool goimports -local github.com/evertonstz/go-workflows -l . | wc -l)" -gt 0 ]; then
            echo "Code is not formatted correctly. Please run 'make format'"
            echo "Files that need formatting:"
            go tool goimports -local github.com/evertonstz/go-workflows -l .
            exit 1
          fi
          echo "Code formatting is correct ✓"

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"

      - name: Install dependencies
        run: go mod download

      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Generate HTML coverage report
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Run teatest integration tests
        run: go test -v -run "TestApp" .

      - name: Verify golden files are up to date
        run: |
          echo "Verifying golden files are current..."
          # Save current golden files for comparison
          cp -r testdata/ testdata-backup/ || true

          # Run the golden file test with -update to check if files need updating
          go test -v -run "TestApp_FullOutput" . -update

          # Check if any files were modified
          if [ -n "$(git status --porcelain testdata/)" ]; then
            echo "❌ Golden files are out of date!"
            echo "Modified files:"
            git status --porcelain testdata/
            echo ""
            echo "Detailed differences:"
            for file in testdata/*.golden; do
              if [ -f "testdata-backup/$(basename $file)" ]; then
                echo "=== Diff for $(basename $file) ==="
                diff -u "testdata-backup/$(basename $file)" "$file" || true
                echo ""
              fi
            done
            echo ""
            echo "This could be due to:"
            echo "1. UI changes that need golden file updates"
            echo "2. Environment differences (terminal capabilities, etc.)"
            echo ""
            echo "To fix this:"
            echo "1. Run 'make test-integration-update' locally"
            echo "2. Review the changes in testdata/"
            echo "3. If changes are expected, commit them"
            echo "4. If changes are unexpected, investigate the UI logic"
            echo ""
            echo "Current environment info:"
            echo "TERM: $TERM"
            echo "COLORTERM: $COLORTERM"
            echo "CI: $CI"
            exit 1
          fi
          echo "✅ Golden files are up to date"

      - name: Upload coverage reports to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-pr
          path: |
            coverage.out
            coverage.html
          retention-days: 30

      - name: Add coverage comment to PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            try {
              // Read coverage percentage from go test output or coverage.out
              const { execSync } = require('child_process');
              const coverageOutput = execSync('go tool cover -func=coverage.out | tail -1', { encoding: 'utf8' });
              const coverageMatch = coverageOutput.match(/(\d+\.\d+)%/);
              const coveragePercent = coverageMatch ? coverageMatch[1] : 'unknown';
              
              const body = `## 📊 Test Coverage Report

              **Coverage: ${coveragePercent}%**
              
              - Coverage report has been generated and uploaded as an artifact
              - Download the coverage report from the "Artifacts" section below
              - HTML report provides detailed line-by-line coverage information
              
              🎯 **Coverage by package:**
              \`\`\`
              ${execSync('go tool cover -func=coverage.out', { encoding: 'utf8' })}
              \`\`\``;
              
              // Find existing coverage comment
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const existingComment = comments.data.find(comment => 
                comment.body.includes('📊 Test Coverage Report')
              );
              
              if (existingComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: existingComment.id,
                  body: body
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: body
                });
              }
            } catch (error) {
              console.log('Coverage comment failed:', error.message);
            }

  build:
    name: Build
    needs: [lint, test] # Ensure tests pass before building
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"

      - name: Build
        run: go build -ldflags "-X main.Version=ci-${{ github.sha }}" .
